<!doctype html>
<html lang="es">
<head>
Â  <meta charset="UTF-8" />
Â  <title>Ordenar Comida - CUAH-QUICK</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <link rel="icon" href="logo.png" type="image/png">
Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
Â  <link rel="stylesheet" href="styles.css">Â 
Â  </head>
<body>

Â  <div class="cursor-glow" id="cursorGlow"></div>

Â  <nav class="nav">
Â  Â  <div class="nav-inner container">
Â  Â  Â  <a class="brand" href="index.html" aria-label="Inicio">
Â  Â  Â  Â  <img src="logo.png" alt="Logo CUAH-QUICK" class="brand-logo-img">
Â  Â  Â  Â  <strong>CUAH-QUICK</strong>
Â  Â  Â  </a>
Â  Â  Â  <div class="menu" aria-label="Principal">
Â  Â  Â  Â  <a class="btn btn-outline" href="index.html#producto">Producto</a>
Â  Â  Â  Â  <a class="btn btn-outline" href="index.html#mision-vision">MisiÃ³n & VisiÃ³n</a>
Â  Â  Â  Â  <a class="btn btn-outline" href="index.html#como-funciona">CÃ³mo funciona</a>
Â  Â  Â  Â  <a class="btn btn-primary" href="ordenar.html">Ordenar Comida</a>
Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="btn btn-outline" id="logoutBtn" style="display:none;" onclick="logout()">Cerrar SesiÃ³n</button>
Â  Â  </div>
Â  </nav>

Â  <section id="ordenar-page" class="section">
Â  Â  <div class="container reveal-parent" style="max-width: 860px;">
Â  Â  Â Â 
Â  Â  Â  <h1 class="h1 reveal-child" data-delay="100" style="text-align: center; font-size: clamp(2rem, 5vw, 3.2rem); margin-bottom: 1rem;">
Â  Â  Â  Â  <span id="hero-emoji" style="display: inline-block; transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1);">ğŸ”</span>Â 
Â  Â  Â  Â  <span id="welcome-message">Elige tu pedido</span>
Â  Â  Â  </h1>

Â  Â  Â  <p class="p-muted reveal-child" data-delay="200" style="text-align: center; font-size: 1.15rem; max-width: 52ch; margin: 0 auto 2.5rem auto;">
Â  Â  Â  Â  Selecciona la tienda de tu campus, aÃ±ade productos a tu carrito y paga de forma segura.
Â  Â  Â  </p>

Â  Â  Â  <div class="card reveal-child" data-delay="300" style="padding: 1.5rem 2rem;">
Â  Â  Â  Â  <h3 class="h2">1. Selecciona una tienda</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="feature" style="margin-top: 1rem; cursor: pointer;">
Â  Â  Â  Â  Â  <span style="color:var(--brand1)">ğŸ«</span>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div style="font-weight:700">CafeterÃ­a Central (ID: 1)</div>
Â  Â  Â  Â  Â  Â  <div class="p-muted" style="font-size:.9rem">Abierto 8 AM <strong>Â·</strong> Cierra 6:00 PM</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div class="card reveal-child" data-delay="400" style="margin-top: 1.5rem; padding: 1.5rem 2rem;">
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  <h3 class="h2" style="margin:0;">2. Arma tu carrito</h3>
Â  Â  Â  Â  Â  <span class="p-muted" id="products-count" style="font-size:0.9rem">Cargando productos...</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â 
Â  Â  Â  Â  <div id="menu-container" class="menu-grid">
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="cta reveal-child" data-delay="500" style="margin-top: 1.5rem; padding: 1.5rem 2rem;">
Â  Â  Â  Â  <form id="paymentForm">
Â  Â  Â  Â  Â  <div class="grid grid-2" style="align-items:center">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <h3 class="h2" style="font-size:1.6rem">3. Detalles de Entrega</h3>
Â  Â  Â  Â  Â  Â  Â  <p class="p-muted" id="total-text">Total: $0.00 MXN</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <input type="text" id="building" placeholder="Edificio de Entrega (Ej: A)" required>
Â  Â  Â  Â  Â  Â  Â  <input type="text" id="classroom" placeholder="SalÃ³n/Oficina (Ej: A205)" required>
Â  Â  Â  Â  Â  Â  Â  <textarea id="delivery_notes" placeholder="Notas de entrega (Opcional)"></textarea>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="text-align: right; margin-top: 1rem;">
Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-primary" id="payBtn">Proceder al Pago</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <p id="order-message" style="margin-top: 10px; font-weight: bold;"></p>
Â  Â  Â  Â  </form>
Â  Â  Â  </div>

Â  Â  </div>
Â  </section>

Â  <footer class="footer">
Â  Â  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap">
Â  Â  Â  <div style="display:flex;align-items:center;gap:.5rem">
Â  Â  Â  Â  <img src="logo.png" alt="" style="width:20px; height:20px; border-radius: 4px; object-fit: cover;">
Â  Â  Â  Â  <span>CUAH-QUICK Â© <span id="year-footer"></span></span>
Â  Â  Â  </div>
Â  Â  Â  <div style="display:flex;gap:1rem">
Â  Â  Â  Â  <a href="index.html#mision-vision">MisiÃ³n</a>
Â  Â  Â  Â  <a href="index.html#mision-vision">VisiÃ³n</a>
Â  Â  Â  Â  <a href="#">TÃ©rminos</a>
Â  Â  Â  </div>
Â  Â  </div>
Â  </footer>

Â  <script>
Â  Â  // ===================================================================================
Â  Â  // === LÃ“GICA DE SEGURIDAD Y CONEXIÃ“N A BASE DE DATOS (NUEVO CÃ“DIGO) ===
Â  Â  // ===================================================================================

    // La URL de tu API desplegada
    const API_BASE_URL = 'https://backend-cuah-quick-api.onrender.com/api'; 
    let totalCuenta = 0;
    
    // Lista de productos seleccionados (para enviar detalles si fuera necesario)
    let carrito = []; 


    // ===============================================
    // 1. LÃ“GICA DE AUTENTICACIÃ“N Y CIERRE DE SESIÃ“N
    // ===============================================

    function checkAuthAndLoad() {
        const token = localStorage.getItem('userToken');
        
        if (!token) {
            // Si no hay token, redirigir al login
            alert('ğŸ”’ Debes iniciar sesiÃ³n para hacer un pedido.');
            window.location.href = 'login.html'; 
            return;
        }

        // Mostrar el nombre del usuario (si estÃ¡ guardado)
        const userData = localStorage.getItem('userData');
        if (userData) {
            const user = JSON.parse(userData);
            document.getElementById('welcome-message').textContent = `Hola, ${user.full_name}.`;
        }

        document.getElementById('logoutBtn').style.display = 'block';
        
        // Cargar productos solo si la autenticaciÃ³n es exitosa
        obtenerProductosReales();
    }

    function logout() {
        localStorage.removeItem('userToken');
        localStorage.removeItem('userData');
        alert('Cerraste sesiÃ³n.');
        window.location.href = 'login.html'; 
    }

    // ===============================================
    // 2. OBTENER PRODUCTOS (GET /api/products)
    // ===============================================
    async function obtenerProductosReales() {
        try {
            // Ya no es necesario usar la URL fija, usa API_BASE_URL
            const respuesta = await fetch(`${API_BASE_URL}/products`);
            
            if (!respuesta.ok) {
                throw new Error(`Error HTTP: ${respuesta.status}`);
            }

            const productosDB = await respuesta.json();
            
            renderizarMenu(productosDB); 
            
            // Actualizar contador
            document.getElementById('products-count').textContent = `${productosDB.length} productos disponibles`;

        } catch (error) {
            console.error("Error cargando productos:", error);
            document.getElementById('menu-container').innerHTML = 
                '<p style="color:red; margin-top:1rem;">âŒ Error: No se pudo cargar el menÃº.</p>';
        }
    }

    // ===============================================
    // 3. LÃ“GICA DE CARRITO Y TOTAL
    // ===============================================
    function renderizarMenu(productos) {
        const contenedor = document.getElementById('menu-container');
        contenedor.innerHTML = ''; 

        productos.forEach(prod => {
            let emoji = "ğŸ´";
            if(prod.name.includes('Agua')) emoji = "ğŸ’§";
            else if(prod.name.includes('Coca-Cola')) emoji = "ğŸ¥¤";
            else if(prod.name.includes('Papas')) emoji = "ğŸ¥”";
            else if(prod.name.includes('SÃ¡ndwich')) emoji = "ğŸ¥ª";
            else if(prod.name.includes('Galletas')) emoji = "ğŸª";

            const htmlProducto = `
                <div class="product-card">
                    <div class="product-header">
                        <div class="product-emoji">${emoji}</div>
                        <div class="product-info">
                            <h4>${prod.name}</h4>
                        </div>
                    </div>
                    <p class="product-desc">${prod.description}</p>
                    <div class="product-footer">
                        <span class="price">$${Number(prod.price).toFixed(2)}</span>
                        <button class="btn-add" onclick="agregarProducto(${prod.id}, ${prod.price}, '${prod.name}')">
                            Agregar +
                        </button>
                    </div>
                </div>
            `;
            contenedor.innerHTML += htmlProducto;
        });
    }

    function agregarProducto(id, precio, nombre) {
        totalCuenta += Number(precio);
        carrito.push({ id, precio, nombre, cantidad: 1 }); // AÃ±adir al carrito
        
        const textoTotal = document.getElementById('total-text');
        
        if(textoTotal) {
            textoTotal.textContent = `Total: $${totalCuenta.toFixed(2)} MXN`;
            textoTotal.style.color = '#4ade80'; 
            setTimeout(() => textoTotal.style.color = '', 300);
        }
    }

    // ===============================================
    // 4. CREAR ORDEN (POST /api/orders)
    // ===============================================
    const paymentForm = document.getElementById('paymentForm');
    const orderMessageDisplay = document.getElementById('order-message');

    paymentForm.addEventListener('submit', handleCreateOrder);

    async function handleCreateOrder(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('userToken');
        if (!token) {
             orderMessageDisplay.textContent = 'Error: SesiÃ³n no encontrada.';
             return;
        }

        if (totalCuenta <= 0) {
             orderMessageDisplay.textContent = 'AÃ±ade productos a tu carrito antes de pagar.';
             return;
        }

        const orderData = {
            shop_id: 1, // Asumido
            total_amount: totalCuenta.toFixed(2),
            building: document.getElementById('building').value,
            classroom: document.getElementById('classroom').value,
            delivery_notes: document.getElementById('delivery_notes').value,
            // AquÃ­ podrÃ­as aÃ±adir un campo 'items' con la lista del carrito si el backend lo requiere
        };

        document.getElementById('payBtn').disabled = true;
        orderMessageDisplay.textContent = 'Procesando orden...';

        try {
            const response = await fetch(`${API_BASE_URL}/orders`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    // â­ï¸ CRÃTICO: EnvÃ­o del Token JWT
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify(orderData)
            });
            
            const data = await response.json();

            if (response.status === 201) { 
                orderMessageDisplay.textContent = 'ğŸ‰ Â¡Orden creada exitosamente!';
                orderMessageDisplay.style.color = '#28a745';
                // Opcional: Limpiar carrito y formulario
            } else if (response.status === 401) {
                // Token fallido o expirado
                alert('SesiÃ³n expirada. Por favor, vuelve a iniciar sesiÃ³n.');
                logout();
            } else {
                orderMessageDisplay.textContent = `âŒ Error al crear orden: ${data.message || 'Error desconocido'}`; 
                orderMessageDisplay.style.color = 'red';
            }
        } catch (error) {
            console.error('Error de conexiÃ³n:', error);
            orderMessageDisplay.textContent = 'ğŸš¨ Error de red al intentar crear la orden.';
            orderMessageDisplay.style.color = 'red';
        } finally {
            document.getElementById('payBtn').disabled = false;
        }
    }


Â  Â  // ============================================
Â  Â  // === CÃ“DIGO JS EXISTENTE (ANIMACIONES) ===
Â  Â  // ============================================
    document.getElementById('year-footer').textContent = new Date().getFullYear();

Â  Â  const cursorGlow = document.getElementById('cursorGlow');
Â  Â  if (cursorGlow) {
Â  Â  Â  window.addEventListener('mousemove', (e) => {
Â  Â  Â  Â  window.requestAnimationFrame(() => {
Â  Â  Â  Â  Â  cursorGlow.style.left = e.clientX + 'px';
Â  Â  Â  Â  Â  cursorGlow.style.top = e.clientY + 'px';
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }

Â  Â  const heroEmoji = document.getElementById('hero-emoji');
Â  Â  const orderSection = document.getElementById('ordenar-page');
Â  Â Â 
Â  Â  if (heroEmoji && orderSection) {
Â  Â  Â  orderSection.addEventListener('mousemove', (e) => {
Â  Â  Â  Â  const rect = orderSection.getBoundingClientRect();
Â  Â  Â  Â  const centerX = rect.left + rect.width / 2;
Â  Â  Â  Â  const centerY = rect.top + rect.height / 2;
Â  Â  Â  Â  const xMov = (e.clientX - centerX) / (rect.width / 2);Â 
Â  Â  Â  Â  const yMov = (e.clientY - centerY) / (rect.height / 2);
Â  Â  Â  Â  const intensity = 10;Â 

Â  Â  Â  Â  window.requestAnimationFrame(() => {
Â  Â  Â  Â  Â  heroEmoji.style.transform = `translate3d(${-xMov * intensity}px, ${-yMov * intensity}px, 0)`;
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  orderSection.addEventListener('mouseleave', () => {
Â  Â  Â  Â  Â window.requestAnimationFrame(() => {
Â  Â  Â  Â  Â  Â  heroEmoji.style.transform = 'translate3d(0,0,0)';Â 
Â  Â  Â  Â  Â });
Â  Â  Â  });
Â  Â  }

Â  Â  const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
Â  Â  const observerCallback = (entries, observer) => {
Â  Â  Â  entries.forEach(entry => {
Â  Â  Â  Â  if (entry.isIntersecting) {
Â  Â  Â  Â  Â  if (entry.target.classList.contains('reveal-parent')) {
Â  Â  Â  Â  Â  Â  const children = entry.target.querySelectorAll('.reveal-child');
Â  Â  Â  Â  Â  Â  children.forEach((child, index) => {
Â  Â  Â  Â  Â  Â  Â  const delay = child.dataset.delay || (index * 100);Â 
Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { child.classList.add('visible'); }, delay);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const delay = entry.target.dataset.delay || 0;
Â  Â  Â  Â  Â  Â  setTimeout(() => { entry.target.classList.add('visible'); }, delay);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  observer.unobserve(entry.target);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  };
Â  Â  const revealObserver = new IntersectionObserver(observerCallback, observerOptions);
Â  Â  document.querySelectorAll('.reveal-parent').forEach(parent => revealObserver.observe(parent));
Â  Â  document.querySelectorAll('.reveal-child:not(.reveal-parent .reveal-child)').forEach(child => revealObserver.observe(child));

Â  Â  // Iniciar la verificaciÃ³n de autenticaciÃ³n al cargar la pÃ¡gina
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  checkAuthAndLoad();
Â  Â  });

Â  </script>
</body>
</html>
